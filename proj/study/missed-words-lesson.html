<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”™è¯å¤ä¹ </title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/settings.css">
    <style>
        .unit-container { max-width: 1100px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .unit-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; }
        .title { font-size: 22px; font-weight: 700; }
        .meta { color:#7f8c8d; }
        .word-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; margin-top: 10px; }
        .word-item { background:#f8f9fa; border:1px solid #ecf0f1; border-radius:8px; padding:10px; }
        .word-text { display:flex; align-items:center; gap:6px; }
        .w { font-weight:700; }
        .phon { color:#3498db; margin-left:6px; font-weight:400; }
        .mean { color:#7f8c8d; font-size: 0.9em; }
        .section-title { margin-top: 22px; font-size: 18px; font-weight: 700; }
        .story-box { background:#fffaf1; border:1px solid #ffe3a3; border-radius:8px; padding:16px; line-height:1.7; }
        .actions { display:flex; gap:10px; margin-top:12px; }
        .btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
        .btn-primary { background:#3498db; color:#fff; }
        .btn-secondary { background:#ecf0f1; }
        .btn-success { background:#27ae60; color:#fff; }
        .back { margin: 10px 0 0 0; display:inline-block; color:#3498db; text-decoration:none; }
        /* å°å–‡å­æŒ‰é’®ï¼šä»…æ¯”å›¾æ ‡å¤§ä¸€åœˆ */
        .speak-btn { width: 22px; height: 22px; min-width:22px; min-height:22px; border-radius: 50%;
            display:inline-flex; align-items:center; justify-content:center; border:1px solid #d9e2ea; background:#eef3f7; cursor:pointer; padding:0; }
        .speak-btn span { font-size: 13px; line-height:1; }
        .speak-btn:hover { background:#e2f2ff; }
        .loading { text-align: center; padding: 60px 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; 
            animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 60px 20px; color: #95a5a6; }
        .empty-icon { font-size: 4em; margin-bottom: 20px; }
        .error-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="unit-container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: #7f8c8d;">æ­£åœ¨åŠ è½½é”™è¯...</p>
        </div>

        <div id="content-area" style="display: none;">
            <div class="unit-header">
                <div>
                    <div class="title" id="file-name">é”™è¯å¤ä¹ </div>
                    <div class="meta" id="summary">æ­£åœ¨åŠ è½½...</div>
                </div>
                <a class="back" href="../settings.html">â† è¿”å›è®¾ç½®</a>
            </div>

            <div class="section-title">
                å•è¯åˆ—è¡¨
                <span class="error-badge" id="error-count">é”™è¯¯ 1 æ¬¡</span>
            </div>
            <div class="actions" style="margin:6px 0 10px 0;">
                <button class="btn btn-primary" id="play-all">â–¶ï¸ å…¨éƒ¨æœ—è¯»</button>
                <button class="btn" id="stop-all">â¹ï¸ åœæ­¢</button>
            </div>
            <div id="word-list" class="word-list"></div>

            <div class="actions" style="margin-top: 30px;">
                <button class="btn btn-success" onclick="startPractice()">ğŸ® å¼€å§‹ç»ƒä¹ </button>
                <button class="btn btn-secondary" onclick="exportWords()">ğŸ“¥ å¯¼å‡ºå•è¯</button>
            </div>
        </div>

        <div id="empty" class="empty" style="display: none;">
            <div class="empty-icon">ğŸ“</div>
            <p>é”™è¯æ•°æ®æœªæ‰¾åˆ°</p>
        </div>
    </div>

    <script src="../src/utils/PhoneticFormatter.js"></script>
    <script src="../src/utils/MissedWordsManager.js"></script>
    <script src="../src/utils/TTSService.js"></script>
    <script>
        // è·å– URL å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const fileName = urlParams.get('file');
        let currentWords = [];

        async function loadMissedWords() {
            const loading = document.getElementById('loading');
            const contentArea = document.getElementById('content-area');
            const empty = document.getElementById('empty');

            if (!fileName) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            try {
                // è·å–é”™è¯æ•°æ®
                const manager = window.missedWordsManager;
                await manager.getUserIP();
                const allWords = await manager.getMissedWords();

                // æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶
                const missedWord = allWords.find(w => w.word === fileName);

                if (!missedWord) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                // è§£æå•è¯æ•°æ®ï¼ˆä» meaning å­—æ®µï¼‰
                try {
                    currentWords = JSON.parse(missedWord.meaning);
                } catch (e) {
                    // å…¼å®¹æ—§æ ¼å¼ï¼šé€—å·åˆ†éš”çš„å•è¯åˆ—è¡¨
                    const wordList = missedWord.meaning.split(',').map(w => w.trim()).filter(w => w);
                    currentWords = wordList.map(word => ({
                        word: word,
                        phonetic: '',
                        meaning: ''
                    }));
                }

                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.getElementById('file-name').textContent = fileName;
                document.getElementById('summary').textContent = `${missedWord.phonetic} Â· ${currentWords.length} ä¸ªå•è¯`;
                document.getElementById('error-count').textContent = `é”™è¯¯ ${missedWord.count} æ¬¡`;

                // æ¸²æŸ“å•è¯å¡ç‰‡
                const wordListContainer = document.getElementById('word-list');
                wordListContainer.innerHTML = '';

                currentWords.forEach((w, idx) => {
                    const div = document.createElement('div');
                    div.className = 'word-item';
                    const formattedPhonetic = PhoneticFormatter.format(w.phonetic);
                    div.innerHTML = `<div class="word-text">
                        <button title="æœ—è¯»" class="speak-btn" data-say="${w.word}"><span>ğŸ”Š</span></button>
                        <span class="w">${w.word}</span><span class="phon"> ${formattedPhonetic}</span>
                    </div>
                    <div class="mean">${w.meaning || ''}</div>`;
                    
                    const speakEl = div.querySelector('[data-say]');
                    const speak = async () => {
                        try {
                            const tts = window.TTSService.getInstance();
                            await tts.unlockAudioContext(true);
                            await tts.speak(w.word, { showError: false });
                        } catch (err) {
                            console.error('æœ—è¯»å¤±è´¥:', err);
                        }
                    };
                    
                    speakEl.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        speak();
                    });
                    
                    let hoverTimer = null;
                    speakEl.addEventListener('mouseenter', () => {
                        hoverTimer = setTimeout(speak, 120);
                    });
                    speakEl.addEventListener('mouseleave', () => {
                        if (hoverTimer) {
                            clearTimeout(hoverTimer);
                            hoverTimer = null;
                        }
                    });
                    
                    div.querySelector('.w').addEventListener('click', async () => {
                        try {
                            const tts = window.TTSService.getInstance();
                            await tts.unlockAudioContext(true);
                            await tts.speak(w.word, { showError: false });
                        } catch (err) {}
                    });
                    
                    wordListContainer.appendChild(div);
                });

                // å…¨éƒ¨æœ—è¯»åŠŸèƒ½
                let readAllController = null;
                function createCancelController() {
                    let cancelFn;
                    const promise = new Promise(resolve => { cancelFn = resolve; });
                    return { promise, cancel: () => cancelFn && cancelFn() };
                }
                
                document.getElementById('play-all').onclick = async () => {
                    if (window._readingAll) return;
                    window._readingAll = true;
                    readAllController = createCancelController();
                    const tts = window.TTSService.getInstance();
                    await tts.unlockAudioContext(true);
                    
                    for (const item of currentWords) {
                        await Promise.race([
                            tts.speak(item.word, { showError: false }),
                            readAllController.promise
                        ]);
                        if (!window._readingAll) break;
                        await Promise.race([
                            new Promise(r => setTimeout(r, 150)),
                            readAllController.promise
                        ]);
                        if (!window._readingAll) break;
                    }
                    window._readingAll = false;
                };
                
                document.getElementById('stop-all').onclick = () => {
                    try {
                        window.TTSService.getInstance().stop();
                    } catch (e) {}
                    if (readAllController) {
                        readAllController.cancel();
                    }
                    window._readingAll = false;
                };

                loading.style.display = 'none';
                contentArea.style.display = 'block';

            } catch (error) {
                console.error('åŠ è½½é”™è¯å¤±è´¥:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
            }
        }

        function exportWords() {
            if (currentWords.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å•è¯');
                return;
            }
            
            try {
                // åˆ›å»ºæ–‡æœ¬å†…å®¹
                let content = '';
                currentWords.forEach(word => {
                    content += `${word.word}, ${word.phonetic}, ${word.meaning}\n`;
                });
                
                // åˆ›å»ºä¸‹è½½
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${fileName}.txt`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥');
            }
        }

        function startPractice() {
            if (currentWords.length === 0) {
                alert('æ²¡æœ‰å¯ç»ƒä¹ çš„å•è¯');
                return;
            }
            
            // å°†å½“å‰é”™è¯ä¿å­˜åˆ°ä¸´æ—¶ç»ƒä¹ åˆ—è¡¨
            try {
                localStorage.setItem('wordTetris_tempPracticeWords', JSON.stringify(currentWords));
                console.log('âœ… å·²ä¿å­˜', currentWords.length, 'ä¸ªé”™è¯åˆ°ä¸´æ—¶ç»ƒä¹ åˆ—è¡¨');
                
                // è·³è½¬åˆ°æ¸¸æˆé¡µé¢
                window.location.href = '../index.html';
            } catch (error) {
                console.error('ä¿å­˜ç»ƒä¹ å•è¯å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ•°æ®
        window.addEventListener('DOMContentLoaded', loadMissedWords);
    </script>
</body>
</html>
