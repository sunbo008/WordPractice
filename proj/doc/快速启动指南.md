# Web 服务快速启动指南

> 一键启动、停止和管理 monkeysoft.cn Web 服务

---

## 🚀 快速开始

### 方式一：使用管理脚本（推荐）

```bash
# 进入项目目录
cd /root/workspace/WordPractice/proj

# 启动所有服务
./manage.sh start

# 查看服务状态
./manage.sh status

# 停止所有服务
./manage.sh stop

# 重启所有服务
./manage.sh restart

# 查看日志
./manage.sh logs
```

### 方式二：手动启动

```bash
# 1. 启动 Node.js 服务器（端口 3000）
cd /root/workspace/WordPractice/proj
nohup node dev-server.js > /tmp/dev-server.log 2>&1 &
echo $! > /tmp/dev-server.pid

# 2. 启动 Caddy（HTTPS，端口 80/443）
systemctl start caddy

# 3. 验证服务
curl -I https://monkeysoft.cn/
```

---

## 📋 常用命令

### 启动服务

```bash
# 方式 1: 使用管理脚本
./manage.sh start

# 方式 2: 手动启动
nohup node dev-server.js > /tmp/dev-server.log 2>&1 &
systemctl start caddy
```

### 停止服务

```bash
# 方式 1: 使用管理脚本（推荐）
./manage.sh stop

# 方式 2: 快速停止
pkill -f "node dev-server.js"
systemctl stop caddy

# 方式 3: 优雅停止
systemctl stop caddy    # 先停止 Caddy
sleep 2                 # 等待现有请求
kill $(cat /tmp/dev-server.pid)  # 停止 Node.js
rm /tmp/dev-server.pid
```

### 重启服务

```bash
# 完整重启
./manage.sh restart

# 仅重启 Node.js（代码更改后）
pkill -f "node dev-server.js"
cd /root/workspace/WordPractice/proj
nohup node dev-server.js > /tmp/dev-server.log 2>&1 &

# 仅重启 Caddy（配置更改后）
systemctl restart caddy
# 或重载配置（不中断服务）
systemctl reload caddy
```

### 查看状态

```bash
# 使用管理脚本（详细状态）
./manage.sh status

# 手动查看
systemctl status caddy
ps aux | grep "node dev-server"
lsof -i :443  # HTTPS
lsof -i :80   # HTTP
lsof -i :3000 # Node.js
```

### 查看日志

```bash
# 使用管理脚本
./manage.sh logs

# 实时查看 Caddy 日志
journalctl -u caddy -f

# 实时查看 Node.js 日志
tail -f /tmp/dev-server.log

# 查看最近的错误
journalctl -u caddy -n 50 --no-pager
```

---

## 🔍 故障排查

### 服务无法启动

```bash
# 1. 检查端口占用
lsof -i :80
lsof -i :443
lsof -i :3000

# 2. 查看错误日志
journalctl -u caddy -n 50
tail -50 /tmp/dev-server.log

# 3. 验证配置
caddy validate --config /etc/caddy/Caddyfile
node /root/workspace/WordPractice/proj/dev-server.js  # 前台运行测试
```

### HTTPS 无法访问

```bash
# 1. 检查 Caddy 状态
systemctl status caddy

# 2. 检查证书
caddy list-certificates

# 3. 测试本地访问
curl -I http://localhost:3000/  # Node.js
curl -I https://localhost/      # Caddy

# 4. 测试远程访问
curl -I https://monkeysoft.cn/
```

### Node.js 服务器无响应

```bash
# 1. 检查进程
ps aux | grep "node dev-server"

# 2. 检查日志
tail -50 /tmp/dev-server.log

# 3. 重启服务
pkill -f "node dev-server.js"
cd /root/workspace/WordPractice/proj
node dev-server.js  # 前台运行，查看错误
```

---

## 📊 服务架构

```
互联网
   ↓
Caddy (443/80)
   │
   ├─ SSL 终止
   ├─ HTTP → HTTPS 重定向
   └─ 反向代理
       ↓
Node.js (3000)
   │
   ├─ 静态文件服务
   ├─ _headers 配置
   └─ TTS API 代理
       ↓
   项目文件
```

---

## 🎯 访问地址

- **HTTPS（推荐）**: https://monkeysoft.cn/
- **HTTP（自动重定向）**: http://monkeysoft.cn/
- **本地测试**: http://localhost:3000/

---

## 📁 重要文件

| 文件 | 说明 |
|------|------|
| `/root/workspace/WordPractice/proj/manage.sh` | 服务管理脚本 |
| `/root/workspace/WordPractice/proj/dev-server.js` | Node.js 服务器 |
| `/root/workspace/WordPractice/proj/_headers` | 响应头配置 |
| `/etc/caddy/Caddyfile` | Caddy 配置 |
| `/tmp/dev-server.log` | Node.js 日志 |
| `/tmp/dev-server.pid` | Node.js 进程 ID |

---

## ⚙️ 配置修改

### 修改 Node.js 代码

```bash
# 1. 编辑文件
vim /root/workspace/WordPractice/proj/dev-server.js

# 2. 重启 Node.js
./manage.sh restart
# 或
pkill -f "node dev-server.js"
cd /root/workspace/WordPractice/proj
nohup node dev-server.js > /tmp/dev-server.log 2>&1 &
```

### 修改 _headers 配置

```bash
# 1. 编辑文件
vim /root/workspace/WordPractice/proj/_headers

# 2. 无需重启！下次请求时自动加载
```

### 修改 Caddy 配置

```bash
# 1. 编辑配置
vim /etc/caddy/Caddyfile

# 2. 验证配置
caddy validate --config /etc/caddy/Caddyfile

# 3. 重载配置（不中断服务）
systemctl reload caddy
```

---

## 🔐 开机自启动

### 查看自启动状态

```bash
systemctl is-enabled caddy
```

### 启用开机自启动

```bash
# Caddy 已自动启用
systemctl enable caddy

# Node.js 需要创建 systemd 服务
# 参考完整文档中的说明
```

---

## 📞 获取帮助

```bash
# 查看管理脚本帮助
./manage.sh help

# 查看完整文档
cat /root/workspace/WordPractice/proj/doc/服务器配置完整记录.md

# 查看日志
./manage.sh logs
journalctl -u caddy -f
tail -f /tmp/dev-server.log
```

---

## 💡 最佳实践

1. **日常使用**: 使用 `manage.sh` 脚本管理服务
2. **代码更改**: 仅重启 Node.js，无需重启 Caddy
3. **配置更改**: 使用 `systemctl reload caddy` 而非 `restart`
4. **_headers 更改**: 无需任何重启操作
5. **定期检查**: 使用 `./manage.sh status` 查看服务健康状态
6. **查看日志**: 出现问题时先查看日志

---

## ⚡ 一键命令速查

```bash
# 启动
./manage.sh start

# 停止
./manage.sh stop

# 重启
./manage.sh restart

# 状态
./manage.sh status

# 日志
./manage.sh logs

# 快速检查
systemctl status caddy && ps aux | grep "node dev-server"

# 访问测试
curl -I https://monkeysoft.cn/
```

---

**最后更新**: 2025年10月23日  
**更多信息**: 查看完整文档 `服务器配置完整记录.md`

