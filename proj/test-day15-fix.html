<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day15 词汇加载测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .word-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            display: flex;
            justify-content: space-between;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        #configInfo, #loadedLibraries, #words {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <h1>🔧 Day15 词汇加载问题修复测试</h1>
    
    <div class="test-section">
        <h2>问题分析</h2>
        <div class="info status">
            <strong>问题原因：</strong> 默认配置只加载前4天课程 (day01-day04)，day15没有被包含在内
        </div>
        <div class="success status">
            <strong>修复方案：</strong> 修改配置加载器，默认加载所有15天的daily-phonics课程
        </div>
    </div>

    <div class="test-section">
        <h2>1. 配置加载测试</h2>
        <button onclick="testConfigLoader()">测试配置加载器</button>
        <div id="configStatus"></div>
        <pre id="configInfo"></pre>
    </div>

    <div class="test-section">
        <h2>2. 词汇管理器测试</h2>
        <button onclick="testVocabManager()">测试词汇管理器</button>
        <div id="vocabStatus"></div>
        <pre id="loadedLibraries"></pre>
    </div>

    <div class="test-section">
        <h2>3. Day15单词加载测试</h2>
        <button onclick="testDay15Words()">加载Day15单词</button>
        <div id="day15Status"></div>
        <div id="words"></div>
    </div>

    <div class="test-section">
        <h2>4. 随机单词生成测试</h2>
        <button onclick="testRandomWords()">生成10个随机单词</button>
        <div id="randomStatus"></div>
        <div id="randomWords"></div>
    </div>

    <!-- 添加时间戳避免缓存 -->
    <script src="vocabulary-config-loader.js?v=20251006-fix2"></script>
    <script src="vocabulary-manager-v2.js?v=20251006-fix2"></script>
    
    <script>
        let configLoader;
        let vocabManager;

        async function testConfigLoader() {
            const statusDiv = document.getElementById('configStatus');
            const infoDiv = document.getElementById('configInfo');
            
            try {
                statusDiv.innerHTML = '<div class="info status">⏳ 正在加载配置...</div>';
                
                configLoader = new VocabularyConfigLoader();
                const config = await configLoader.loadConfig();
                
                statusDiv.innerHTML = '<div class="success status">✅ 配置加载成功！</div>';
                
                const dailyPhonics = config.categories.find(c => c.id === 'daily-phonics');
                const enabledLibs = config.defaultConfig.enabledLibraries;
                const hasDay15 = enabledLibs.includes('day15');
                
                infoDiv.textContent = `配置信息：
- Daily Phonics课程数: ${dailyPhonics.subcategories.length}
- 默认启用课程数: ${enabledLibs.length}
- 是否包含Day15: ${hasDay15 ? '✅ 是' : '❌ 否'}
- 启用的课程: ${enabledLibs.join(', ')}

Day15配置:
${JSON.stringify(dailyPhonics.subcategories.find(s => s.id === 'day15'), null, 2)}`;
                
                if (!hasDay15) {
                    statusDiv.innerHTML += '<div class="error status">❌ 警告：Day15未包含在默认配置中！</div>';
                }
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="error status">❌ 配置加载失败: ' + error.message + '</div>';
                console.error(error);
            }
        }

        async function testVocabManager() {
            const statusDiv = document.getElementById('vocabStatus');
            const libDiv = document.getElementById('loadedLibraries');
            
            try {
                statusDiv.innerHTML = '<div class="info status">⏳ 正在初始化词汇管理器...</div>';
                
                vocabManager = new VocabularyManagerV2();
                
                // 等待加载完成
                await new Promise(resolve => {
                    const checkLoaded = setInterval(() => {
                        if (vocabManager.isLoaded) {
                            clearInterval(checkLoaded);
                            resolve();
                        }
                    }, 100);
                });
                
                statusDiv.innerHTML = '<div class="success status">✅ 词汇管理器初始化成功！</div>';
                
                const stats = vocabManager.getLibraryStats();
                const config = vocabManager.getCurrentConfig();
                const hasDay15 = vocabManager.loadedLibraries.has('day15');
                
                libDiv.textContent = `词汇管理器状态：
- 已加载词库数: ${stats.totalLibraries}
- 总单词数: ${stats.totalWords}
- 是否加载Day15: ${hasDay15 ? '✅ 是' : '❌ 否'}
- 启用的词库: ${config.enabledLibraries.join(', ')}

已加载的词库:
${stats.libraries.map(lib => `  - ${lib.id}: ${lib.name} (${lib.wordCount}词)`).join('\n')}`;
                
                if (!hasDay15) {
                    statusDiv.innerHTML += '<div class="error status">❌ 警告：Day15未加载！</div>';
                }
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="error status">❌ 词汇管理器初始化失败: ' + error.message + '</div>';
                console.error(error);
            }
        }

        async function testDay15Words() {
            const statusDiv = document.getElementById('day15Status');
            const wordsDiv = document.getElementById('words');
            
            try {
                statusDiv.innerHTML = '<div class="info status">⏳ 正在加载Day15单词...</div>';
                
                const response = await fetch('./words/daily-phonics/day15.json');
                if (!response.ok) {
                    throw new Error('Day15文件不存在或无法访问');
                }
                
                const data = await response.json();
                
                statusDiv.innerHTML = '<div class="success status">✅ Day15单词加载成功！</div>';
                
                wordsDiv.innerHTML = `
<strong>Day15 - ${data.metadata.name}</strong>
<p>音标: ${data.metadata.phoneme} | 难度: ${data.metadata.difficulty} | 单词数: ${data.metadata.wordCount}</p>
<div>
    ${data.words.map((w, i) => `
        <div class="word-item">
            <span>${i + 1}. ${w.word}</span>
            <span>${w.phonetic}</span>
            <span>${w.meaning}</span>
            <span>难度${w.difficulty}</span>
        </div>
    `).join('')}
</div>
                `;
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="error status">❌ Day15单词加载失败: ' + error.message + '</div>';
                console.error(error);
            }
        }

        async function testRandomWords() {
            const statusDiv = document.getElementById('randomStatus');
            const wordsDiv = document.getElementById('randomWords');
            
            if (!vocabManager || !vocabManager.isLoaded) {
                statusDiv.innerHTML = '<div class="error status">❌ 请先运行"测试词汇管理器"</div>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<div class="info status">⏳ 正在生成随机单词...</div>';
                
                const randomWords = [];
                for (let i = 0; i < 10; i++) {
                    const difficulty = (i % 3) + 1;
                    const word = vocabManager.getRandomWord(difficulty);
                    if (word) {
                        randomWords.push(word);
                    }
                }
                
                if (randomWords.length === 0) {
                    throw new Error('无法生成随机单词');
                }
                
                statusDiv.innerHTML = '<div class="success status">✅ 随机单词生成成功！</div>';
                
                wordsDiv.innerHTML = randomWords.map((w, i) => `
                    <div class="word-item">
                        <span>${i + 1}. ${w.original}</span>
                        <span>${w.phonetic}</span>
                        <span>${w.meaning}</span>
                        <span>难度${w.difficulty}</span>
                        <span>显示: ${w.display}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="error status">❌ 随机单词生成失败: ' + error.message + '</div>';
                console.error(error);
            }
        }

        // 页面加载时自动运行基本测试
        window.addEventListener('load', () => {
            console.log('=== Day15 词汇加载问题修复测试 ===');
            setTimeout(() => {
                testConfigLoader();
                setTimeout(() => {
                    testVocabManager();
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>

