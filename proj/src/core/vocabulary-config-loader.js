/**
 * åŠ¨æ€è¯åº“é…ç½®åŠ è½½å™¨ v2.0 (ä¼˜åŒ–ç‰ˆ)
 * - ä½¿ç”¨ç´¢å¼•æ–‡ä»¶é¿å…æ— æ•ˆè¯·æ±‚
 * - å¹¶è¡ŒåŠ è½½æå‡é€Ÿåº¦
 * - åªåŠ è½½å…ƒæ•°æ®ï¼Œå»¶è¿ŸåŠ è½½å•è¯æ•°æ®
 */
class VocabularyConfigLoader {
    constructor() {
        this.config = null;
        this.loadError = null;
        this.manifest = null;
    }
    
    /**
     * åŠ è½½è¯åº“ç´¢å¼•æ–‡ä»¶
     */
    async loadManifest() {
        try {
            const response = await fetch('./words/manifest.json');
            if (response.ok) {
                this.manifest = await response.json();
                console.log('ğŸ“‹ ç´¢å¼•æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', this.manifest.version);
                return this.manifest;
            }
        } catch (error) {
            console.warn('âš ï¸ ç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¢æµ‹æ¨¡å¼ï¼ˆè¾ƒæ…¢ï¼‰');
        }
        return null;
    }
    
    /**
     * åŠ è½½é…ç½®ï¼ˆè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆï¼‰
     */
    async loadConfig() {
        try {
            const totalStart = performance.now();
            if (typeof debugLog !== 'undefined') {
                debugLog.info('â±ï¸ [ConfigLoader] å¼€å§‹åŠ è½½è¯åº“é…ç½®...');
            }
            this.showLoadingProgress('æ­£åœ¨åŠ è½½è¯åº“é…ç½®...');
            
            // å…ˆåŠ è½½ç´¢å¼•æ–‡ä»¶
            const manifestStart = performance.now();
            await this.loadManifest();
            if (typeof debugLog !== 'undefined') {
                debugLog.info(`â±ï¸ [ConfigLoader] ç´¢å¼•æ–‡ä»¶åŠ è½½è€—æ—¶: ${(performance.now() - manifestStart).toFixed(2)}ms`);
            }
            
            // å¹¶è¡Œæ‰«ææ‰€æœ‰ç›®å½•
            const scanStart = performance.now();
            const [dailyPhonics, specialPractice, gradeBased, extracurricularBooks] = await Promise.all([
                this.scanDailyPhonics(),
                this.scanSpecialPractice(),
                this.scanGradeBased(),
                this.scanExtracurricularBooks()
            ]);
            if (typeof debugLog !== 'undefined') {
                debugLog.info(`â±ï¸ [ConfigLoader] å¹¶è¡Œæ‰«ææ‰€æœ‰ç›®å½•è€—æ—¶: ${(performance.now() - scanStart).toFixed(2)}ms`);
            }
            
            this.hideLoadingProgress();
            
            // æ„å»ºé…ç½®å¯¹è±¡
            this.config = {
                metadata: {
                    version: "2.0",
                    description: "Word Tetris åˆ†å¸ƒå¼è¯åº“é…ç½® - è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ",
                    lastUpdated: new Date().toISOString().split('T')[0],
                    autoGenerated: true,
                    generatedBy: "JavaScript Runtime",
                    optimized: true
                },
                categories: [
                    {
                        id: "daily-phonics",
                        name: "æŒ‰å¤©å­¦ä¹ éŸ³æ ‡",
                        description: "15å¤©éŸ³æ ‡å­¦ä¹ è®¡åˆ’ï¼Œç³»ç»ŸæŒæ¡åŸºç¡€éŸ³æ ‡",
                        icon: "ğŸ“…",
                        subcategories: dailyPhonics
                    },
                    {
                        id: "special-practice",
                        name: "ä¸“é¡¹å¼ºåŒ–ç»ƒä¹ ",
                        description: "é’ˆå¯¹é‡ç‚¹éŸ³æ ‡è¿›è¡Œå¼ºåŒ–è®­ç»ƒ",
                        icon: "ğŸ¯",
                        subcategories: specialPractice
                    },
                    {
                        id: "grade-based",
                        name: "æŒ‰å¹´çº§åˆ†ç±»",
                        description: "å°å­¦ã€åˆä¸­ã€é«˜ä¸­å„å¹´çº§å­¦æœŸè¯æ±‡",
                        icon: "ğŸ“",
                        subcategories: gradeBased
                    },
                    {
                        id: "extracurricular-books",
                        name: "è¯¾å¤–ä¹¦é˜…è¯»",
                        description: "ç»å…¸è‹±æ–‡åŸç‰ˆä¹¦ç±åˆ†çº§é˜…è¯»",
                        icon: "ğŸ“š",
                        subcategories: extracurricularBooks
                    }
                ],
                defaultConfig: {
                    // ä½¿ç”¨åŠ¨æ€å‘ç°çš„æ‰€æœ‰ daily-phonics æ–‡ä»¶ä½œä¸ºé»˜è®¤é…ç½®
                    enabledLibraries: dailyPhonics.map(item => item.id),
                    maxWords: 200,
                    difficultyRange: [1, 3],
                    categories: ["daily-phonics"]
                }
            };
            
            const totalTime = performance.now() - totalStart;
            const stats = {
                dailyPhonics: dailyPhonics.length,
                specialPractice: specialPractice.length,
                gradeBased: this.countGradeItems(gradeBased),
                extracurricularBooks: this.countGradeItems(extracurricularBooks),
                defaultEnabled: this.config.defaultConfig.enabledLibraries.length
            };
            console.log('âœ… é…ç½®åŠ è½½å®Œæˆ:', stats);
            console.log(`ğŸ“š è¯¾å¤–ä¹¦ç« èŠ‚æ•°: ${stats.extracurricularBooks}`);
            
            console.log('ğŸ“‹ é»˜è®¤å¯ç”¨çš„è¯¾ç¨‹:', this.config.defaultConfig.enabledLibraries);
            if (typeof debugLog !== 'undefined') {
                debugLog.success(`â±ï¸ [ConfigLoader] æ€»åŠ è½½è€—æ—¶: ${totalTime.toFixed(2)}ms`);
            }
            
            return this.config;
            
        } catch (error) {
            console.error('âŒ é…ç½®åŠ è½½å¤±è´¥:', error);
            this.hideLoadingProgress();
            this.loadError = error;
            throw error;
        }
    }
    
    /**
     * æ‰«æ daily-phonics ç›®å½•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
     * è‡ªåŠ¨æ¢æµ‹ day01.json åˆ° day50.json çš„æ‰€æœ‰æ–‡ä»¶
     */
    async scanDailyPhonics() {
        const startTime = performance.now();
        const directory = './words/daily-phonics';
        if (typeof debugLog !== 'undefined') {
            debugLog.info('â±ï¸ [ConfigLoader] å¼€å§‹æ‰«æ daily-phonics ç›®å½•...');
        }
        
        // ä½¿ç”¨ç´¢å¼•æ–‡ä»¶æˆ–å›é€€åˆ°æ¢æµ‹æ¨¡å¼
        const filesToCheck = this.manifest?.files?.['daily-phonics'] || 
            Array.from({length: 50}, (_, i) => `day${String(i + 1).padStart(2, '0')}`);
        
        console.log(`  ğŸ“‹ å°†æ£€æŸ¥ ${filesToCheck.length} ä¸ªæ–‡ä»¶`);
        
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ–‡ä»¶
        const loadStart = performance.now();
        const loadPromises = filesToCheck.map(filename => 
            this.loadFileMetadata(directory, filename, 'daily')
        );
        
        const results = await Promise.all(loadPromises);
        if (typeof debugLog !== 'undefined') {
            debugLog.info(`â±ï¸ [ConfigLoader] å¹¶è¡ŒåŠ è½½ daily-phonics æ–‡ä»¶è€—æ—¶: ${(performance.now() - loadStart).toFixed(2)}ms`);
        }
        
        // è¿‡æ»¤æ‰åŠ è½½å¤±è´¥çš„æ–‡ä»¶
        const validResults = results.filter(r => r !== null);
        
        const totalTime = performance.now() - startTime;
        if (typeof debugLog !== 'undefined') {
            debugLog.success(`âœ… daily-phonics åŠ è½½å®Œæˆ: ${validResults.length}/${filesToCheck.length} ä¸ªæ–‡ä»¶ï¼Œæ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`);
        }
        return validResults.sort((a, b) => a.id.localeCompare(b.id));
    }
    
    /**
     * æ‰«æ special-practice ç›®å½•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
     * è‡ªåŠ¨æ¢æµ‹å¸¸è§çš„éŸ³æ ‡ç»ƒä¹ æ–‡ä»¶å‘½åæ¨¡å¼
     */
    async scanSpecialPractice() {
        const directory = './words/special-practice';
        console.log('ğŸ” æ‰«æ special-practice ç›®å½•...');
        
        // ä½¿ç”¨ç´¢å¼•æ–‡ä»¶æˆ–é¢„å®šä¹‰åˆ—è¡¨
        const filesToCheck = this.manifest?.files?.['special-practice'] || [
            // å…ƒéŸ³éŸ³æ ‡
            'ae-practice', 'e-practice', 'i-practice', 'o-practice', 'or-practice', 'u-practice',
            'a-practice', 'ar-practice', 'er-practice', 'ir-practice', 'ur-practice',
            'oo-practice', 'ou-practice', 'ow-practice', 'oi-practice', 'oy-practice',
            'ai-practice', 'ay-practice', 'ea-practice', 'ee-practice', 'ie-practice',
            'ue-practice', 'ui-practice', 'au-practice', 'aw-practice', 'ew-practice',
            // è¾…éŸ³éŸ³æ ‡
            'th-practice', 'sh-practice', 'ch-practice', 'ph-practice', 'wh-practice',
            'ng-practice', 'nk-practice', 'ck-practice', 'gh-practice',
            // å…¶ä»–å¯èƒ½çš„å‘½å
            'vowels-practice', 'consonants-practice', 'diphthongs-practice',
            'long-vowels', 'short-vowels', 'silent-e', 'r-controlled'
        ];
        
        console.log(`  ğŸ“‹ å°†æ£€æŸ¥ ${filesToCheck.length} ä¸ªæ–‡ä»¶`);
        
        const loadPromises = filesToCheck.map(filename => 
            this.loadFileMetadata(directory, filename, 'special')
        );
        
        const results = await Promise.all(loadPromises);
        const validResults = results.filter(r => r !== null);
        
        console.log(`âœ… special-practice åŠ è½½å®Œæˆ: ${validResults.length}/${filesToCheck.length} ä¸ªæ–‡ä»¶`);
        return validResults;
    }
    
    /**
     * æ‰«æ grade-based ç›®å½•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
     * è‡ªåŠ¨æ¢æµ‹æ‰€æœ‰å¹´çº§å’Œå­¦æœŸçš„æ–‡ä»¶
     */
    async scanGradeBased() {
        console.log('ğŸ” æ‰«æ grade-based ç›®å½•...');
        
        const gradeStructure = {
            primary: {
                id: "primary-school",
                name: "å°å­¦è¯æ±‡",
                description: "å°å­¦ä¸‰è‡³å…­å¹´çº§è¯æ±‡",
                // åŠ¨æ€æ¢æµ‹ grade1-grade6 çš„æ‰€æœ‰å­¦æœŸ
                gradeRange: [1, 2, 3, 4, 5, 6],
                defaultWords: 60
            },
            middle: {
                id: "middle-school",
                name: "åˆä¸­è¯æ±‡",
                description: "åˆä¸­ä¸ƒè‡³ä¹å¹´çº§è¯æ±‡",
                // åŠ¨æ€æ¢æµ‹ grade7-grade9
                gradeRange: [7, 8, 9],
                defaultWords: 120
            },
            high: {
                id: "high-school",
                name: "é«˜ä¸­è¯æ±‡",
                description: "é«˜ä¸­åè‡³åäºŒå¹´çº§è¯æ±‡",
                // åŠ¨æ€æ¢æµ‹ grade10-grade12
                gradeRange: [10, 11, 12],
                defaultWords: 200
            }
        };
        
        const subcategories = [];
        
        for (const [levelKey, levelInfo] of Object.entries(gradeStructure)) {
            const loadPromises = [];
            
            // åŠ¨æ€æ¢æµ‹æ¯ä¸ªå¹´çº§çš„ä¸¤ä¸ªå­¦æœŸï¼ˆæ”¯æŒæŒ‰å­¦æœŸå’ŒæŒ‰å•å…ƒä¸¤ç§æ ¼å¼ï¼‰
            for (const gradeNum of levelInfo.gradeRange) {
                for (const term of [1, 2]) {
                    // å°è¯•æŒ‰å­¦æœŸæ‰«æï¼ˆæ•´ä¸ªå­¦æœŸä¸€ä¸ªæ–‡ä»¶ï¼‰
                    const gradeId = `grade${gradeNum}-term${term}`;
                    loadPromises.push(
                        this.loadFileMetadata(`./words/grade-based/${levelKey}`, gradeId, 'grade', gradeNum, term, levelInfo.defaultWords)
                    );
                    
                    // å°è¯•æŒ‰å•å…ƒæ‰«æï¼ˆæ¯ä¸ªå•å…ƒä¸€ä¸ªæ–‡ä»¶ï¼Œæœ€å¤š6ä¸ªå•å…ƒï¼‰
                    for (let unit = 1; unit <= 6; unit++) {
                        const unitId = `grade${gradeNum}-term${term}-unit${unit}`;
                        loadPromises.push(
                            this.loadFileMetadata(`./words/grade-based/${levelKey}`, unitId, 'grade', gradeNum, term, levelInfo.defaultWords, unit)
                        );
                    }
                }
            }
            
            const results = await Promise.all(loadPromises);
            const items = results.filter(r => r !== null);
            
            // åªæœ‰åœ¨æ‰¾åˆ°è‡³å°‘ä¸€ä¸ªæ–‡ä»¶æ—¶æ‰æ·»åŠ è¿™ä¸ªåˆ†ç±»
            if (items.length > 0) {
                subcategories.push({
                    id: levelInfo.id,
                    name: levelInfo.name,
                    description: levelInfo.description,
                    items: items
                });
                console.log(`  âœ“ ${levelInfo.name}: å‘ç° ${items.length} ä¸ªæ–‡ä»¶`);
            }
        }
        
        console.log(`âœ… grade-based æ‰«æå®Œæˆï¼Œå‘ç° ${subcategories.length} ä¸ªåˆ†ç±»`);
        return subcategories;
    }
    
    /**
     * æ‰«æ extracurricular-books ç›®å½•ï¼ˆè¯¾å¤–ä¹¦ï¼‰
     * è‡ªåŠ¨æ¢æµ‹ä¹¦ç±ç³»åˆ—å’Œç« èŠ‚æ–‡ä»¶
     */
    async scanExtracurricularBooks() {
        try {
            console.log('ğŸ” æ‰«æ extracurricular-books ç›®å½•...');
            if (typeof debugLog !== 'undefined') {
                debugLog.info('ğŸ” [ConfigLoader] å¼€å§‹æ‰«æ extracurricular-books ç›®å½•...');
            }
        
        const bookSeriesStructure = {
            'magic-tree-house': {
                id: 'magic-tree-house',
                name: 'ç¥å¥‡æ ‘å±‹ç³»åˆ— (Magic Tree House)',
                description: 'é€‚åˆåˆçº§è‹±è¯­å­¦ä¹ è€…çš„å†’é™©æ•…äº‹',
                books: [
                    { num: 1, name: 'Dinosaurs Before Dark', chapters: 10 },
                    { num: 2, name: 'The Knight at Dawn', chapters: 10 },
                    { num: 3, name: 'Mummies in the Morning', chapters: 10 },
                    { num: 4, name: 'Pirates Past Noon', chapters: 10 }
                ]
            },
            'harry-potter': {
                id: 'harry-potter',
                name: 'å“ˆåˆ©Â·æ³¢ç‰¹ç³»åˆ— (Harry Potter)',
                description: 'ç»å…¸é­”æ³•ä¸–ç•Œå†’é™©',
                books: [
                    { num: 1, name: 'Philosopher\'s Stone', cnName: 'é­”æ³•çŸ³', chapters: 17 },
                    { num: 2, name: 'Chamber of Secrets', cnName: 'å¯†å®¤', chapters: 18 }
                ]
            },
            'oxford-reading-tree': {
                id: 'oxford-reading-tree',
                name: 'ç‰›æ´¥é˜…è¯»æ ‘ (Oxford Reading Tree)',
                description: 'ç³»ç»ŸåŒ–åˆ†çº§é˜…è¯»æ•™æ',
                stages: [
                    { stage: 1, books: 6 },
                    { stage: 2, books: 6 },
                    { stage: 3, books: 6 }
                ]
            }
        };
        
        const subcategories = [];
        
        for (const [seriesKey, seriesInfo] of Object.entries(bookSeriesStructure)) {
            const loadPromises = [];
            
            if (seriesInfo.books) {
                // å¤„ç†å›¾ä¹¦-ç« èŠ‚ç»“æ„ï¼ˆç¥å¥‡æ ‘å±‹ã€å“ˆåˆ©æ³¢ç‰¹ï¼‰
                for (const book of seriesInfo.books) {
                    for (let chapter = 1; chapter <= book.chapters; chapter++) {
                        const fileId = `book${String(book.num).padStart(2, '0')}-ch${String(chapter).padStart(2, '0')}`;
                        loadPromises.push(
                            this.loadFileMetadata(
                                `./words/extracurricular-books/${seriesKey}`,
                                fileId,
                                'extracurricular',
                                book.num,           // gradeNum -> book number
                                chapter,            // term -> chapter number
                                150,                // defaultWords
                                book.cnName,        // unit -> ä¸­æ–‡ä¹¦å
                                book.name           // bookName -> è‹±æ–‡ä¹¦å
                            )
                        );
                    }
                }
            } else if (seriesInfo.stages) {
                // å¤„ç†åˆ†çº§-å›¾ä¹¦ç»“æ„ï¼ˆç‰›æ´¥é˜…è¯»æ ‘ï¼‰
                for (const stage of seriesInfo.stages) {
                    for (let bookNum = 1; bookNum <= stage.books; bookNum++) {
                        const fileId = `stage${stage.stage}-book${bookNum}`;
                        loadPromises.push(
                            this.loadFileMetadata(
                                `./words/extracurricular-books/${seriesKey}`,
                                fileId,
                                'extracurricular-ort',
                                stage.stage,
                                bookNum,
                                30
                            )
                        );
                    }
                }
            }
            
            const results = await Promise.all(loadPromises);
            const items = results.filter(r => r !== null);
            
            // è°ƒè¯•æ—¥å¿—ï¼ˆåŒæ—¶è¾“å‡ºåˆ° console å’Œ debugLogï¼‰
            const loadMsg = `  ğŸ“– ${seriesInfo.name}: å°è¯•åŠ è½½ ${loadPromises.length} ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸ ${items.length} ä¸ª`;
            console.log(loadMsg);
            if (typeof debugLog !== 'undefined') {
                debugLog.info(loadMsg);
            }
            
            // åªæœ‰åœ¨æ‰¾åˆ°è‡³å°‘ä¸€ä¸ªæ–‡ä»¶æ—¶æ‰æ·»åŠ è¿™ä¸ªç³»åˆ—
            if (items.length > 0) {
                subcategories.push({
                    id: seriesInfo.id,
                    name: seriesInfo.name,
                    description: seriesInfo.description,
                    items: items
                });
                const successMsg = `  âœ“ ${seriesInfo.name}: å‘ç° ${items.length} ä¸ªç« èŠ‚`;
                console.log(successMsg);
                if (typeof debugLog !== 'undefined') {
                    debugLog.success(successMsg);
                }
            } else {
                const warnMsg = `  âš ï¸ ${seriesInfo.name}: æœªæ‰¾åˆ°ä»»ä½•æ–‡ä»¶`;
                console.log(warnMsg);
                if (typeof debugLog !== 'undefined') {
                    debugLog.warning(warnMsg);
                }
            }
        }
        
            const finalMsg = `âœ… extracurricular-books æ‰«æå®Œæˆï¼Œå‘ç° ${subcategories.length} ä¸ªç³»åˆ—`;
            console.log(finalMsg);
            if (typeof debugLog !== 'undefined') {
                debugLog.success(finalMsg);
            }
            return subcategories;
        } catch (error) {
            console.error('âŒ extracurricular-books æ‰«æå¤±è´¥:', error);
            console.error('é”™è¯¯å †æ ˆ:', error.stack);
            if (typeof debugLog !== 'undefined') {
                debugLog.error(`âŒ extracurricular-books æ‰«æå¤±è´¥: ${error.message}`);
                debugLog.error(`é”™è¯¯å †æ ˆ: ${error.stack}`);
            }
            return []; // è¿”å›ç©ºæ•°ç»„ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
        }
    }
    
    /**
     * åŠ è½½å•ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆåªè·å– metadataï¼Œä¸åŠ è½½å®Œæ•´å•è¯æ•°æ®ï¼‰
     */
    async loadFileMetadata(directory, filename, type = 'daily', gradeNum = null, term = null, defaultWords = 0, unit = null, bookName = null) {
        const filepath = `${directory}/${filename}.json`;
        
        try {
            // ç›´æ¥è·å–æ•°æ®ï¼ˆä¸ç”¨ HEAD é¢„æ£€ï¼‰
            const response = await fetch(filepath);
            if (!response.ok) {
                // åªå¯¹é 404 é”™è¯¯è®°å½•æ—¥å¿—ï¼ˆ404 æ˜¯é¢„æœŸçš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨æ¢æµ‹æ–‡ä»¶ï¼‰
                if (response.status !== 404 && type === 'extracurricular') {
                    console.warn(`âš ï¸ åŠ è½½æ–‡ä»¶å¤±è´¥ [${response.status}]: ${filepath}`);
                }
                return null;
            }
            
            const data = await response.json();
            const metadata = data.metadata || {};
            
            // æ ¹æ®ç±»å‹æ„å»ºç»“æœ
            if (type === 'daily') {
                const dayNum = parseInt(filename.match(/\d+/)?.[0] || '0');
                return {
                    id: metadata.id || filename,
                    name: metadata.name || `Day ${dayNum}`,
                    filename: `daily-phonics/${filename}.json`,
                    phoneme: metadata.phoneme || '',
                    description: metadata.description || '',
                    wordCount: metadata.wordCount || metadata.totalWords || 0,
                    difficulty: metadata.difficulty || 'beginner',
                    recommended: true
                };
            } else if (type === 'special') {
                return {
                    id: metadata.id || filename,
                    name: metadata.name || filename.replace(/-/g, ' '),
                    filename: `special-practice/${filename}.json`,
                    phoneme: metadata.phoneme || '',
                    description: metadata.description || '',
                    wordCount: metadata.wordCount || metadata.totalWords || 0,
                    difficulty: metadata.difficulty || 'intermediate',
                    recommended: false
                };
            } else if (type === 'grade') {
                const gradeName = this.getGradeName(gradeNum, term, unit);
                return {
                    id: metadata.id || filename,
                    name: metadata.name || gradeName,
                    filename: filepath.replace('./words/', ''),
                    description: metadata.description || `${gradeName}å¿…å­¦è¯æ±‡`,
                    wordCount: metadata.wordCount || metadata.totalWords || defaultWords,
                    difficulty: metadata.difficulty || 'beginner',
                    recommended: true
                };
            } else if (type === 'extracurricular') {
                // è¯¾å¤–ä¹¦ç« èŠ‚ï¼ˆç¥å¥‡æ ‘å±‹ã€å“ˆåˆ©æ³¢ç‰¹ç­‰ï¼‰
                // unit = ä¸­æ–‡ä¹¦å, bookName = è‹±æ–‡ä¹¦å
                const cnName = unit || '';
                const enName = bookName || '';
                let displayName = '';
                if (cnName && enName) {
                    displayName = `${cnName}/${enName}`;
                } else if (enName) {
                    displayName = enName;
                } else if (cnName) {
                    displayName = cnName;
                } else {
                    displayName = `Book ${gradeNum}`;
                }
                
                const chapterName = metadata.name || `ç¬¬${gradeNum}æœ¬ã€Š${displayName}ã€‹- ç¬¬${term}ç« `;
                console.log(`  âœ… æˆåŠŸåŠ è½½: ${chapterName} (${filepath})`);
                return {
                    id: metadata.id || filename,
                    name: chapterName,
                    filename: filepath.replace('./words/', ''),
                    description: metadata.description || metadata.chapterTitle || `Chapter ${term}`,
                    wordCount: metadata.wordCount || metadata.totalWords || defaultWords,
                    difficulty: metadata.difficulty || 'beginner',
                    recommended: true
                };
            } else if (type === 'extracurricular-ort') {
                // ç‰›æ´¥é˜…è¯»æ ‘
                return {
                    id: metadata.id || filename,
                    name: metadata.name || `Stage ${gradeNum} - Book ${term}`,
                    filename: filepath.replace('./words/', ''),
                    description: metadata.description || metadata.title || '',
                    wordCount: metadata.wordCount || metadata.totalWords || defaultWords,
                    difficulty: metadata.difficulty || 'beginner',
                    recommended: true
                };
            }
            
        } catch (error) {
            // é™é»˜å¤±è´¥ï¼Œè¿”å› null
            return null;
        }
    }
    
    /**
     * ç”Ÿæˆå¹´çº§åç§°
     */
    getGradeName(gradeNum, term, unit = null) {
        const gradeNames = {
            1: 'ä¸€å¹´çº§', 2: 'äºŒå¹´çº§', 3: 'ä¸‰å¹´çº§', 4: 'å››å¹´çº§', 5: 'äº”å¹´çº§', 6: 'å…­å¹´çº§',
            7: 'ä¸ƒå¹´çº§', 8: 'å…«å¹´çº§', 9: 'ä¹å¹´çº§',
            10: 'é«˜ä¸€', 11: 'é«˜äºŒ', 12: 'é«˜ä¸‰'
        };
        const termName = term === 1 ? 'ä¸Šå†Œ' : 'ä¸‹å†Œ';
        const unitName = unit ? ` Unit ${unit}` : '';
        return `${gradeNames[gradeNum] || `${gradeNum}å¹´çº§`}${termName}${unitName}`;
    }
    
    /**
     * ç»Ÿè®¡å¹´çº§åˆ†ç±»çš„é¡¹ç›®æ•°
     */
    countGradeItems(gradeBased) {
        return gradeBased.reduce((sum, category) => sum + category.items.length, 0);
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½è¿›åº¦
     */
    showLoadingProgress(message) {
        if (typeof document === 'undefined') return;
        
        const loader = document.createElement('div');
        loader.id = 'vocab-config-loader';
        loader.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.85); color: white; padding: 25px 45px;
                        border-radius: 12px; z-index: 9999; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
                                           border-radius: 50%; width: 45px; height: 45px;
                                           animation: spin 0.8s linear infinite; margin: 0 auto 18px;"></div>
                <div style="font-size: 16px; font-weight: 500;">${message}</div>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        `;
        document.body.appendChild(loader);
    }
    
    /**
     * éšè—åŠ è½½è¿›åº¦
     */
    hideLoadingProgress() {
        if (typeof document === 'undefined') return;
        
        const loader = document.getElementById('vocab-config-loader');
        if (loader) {
            loader.style.opacity = '0';
            loader.style.transition = 'opacity 0.3s';
            setTimeout(() => loader.remove(), 300);
        }
    }
    
    /**
     * è·å–é…ç½®
     */
    getConfig() {
        return this.config;
    }
}

// å¯¼å‡ºå•ä¾‹
window.VocabularyConfigLoader = VocabularyConfigLoader;
