# 堆叠区问题调试指南

## 问题描述

单词失败后，正确加入了错词本，但是没有正确加入堆叠区。

## 已添加的调试日志

### 1. `updateFallingWords()` - 失败判定

当单词下降到堆叠区顶部时，会输出：

```
💥 单词失败判定触发:
  - 单词: [单词文本]
  - 单词底部Y: [Y坐标]
  - 堆叠区顶部Y: [Y坐标]
  - 堆叠区当前单词数: [数量]
  - 单词对象: [完整对象]
✅ 已从下降列表移除
✅ 已标记为失败（giveUp=false）
➡️ 准备调用 addToStack...
✅ addToStack 调用完成
📊 失败统计已更新，总失败数: [数量]
```

### 2. `addToStack()` - 添加到堆叠区

```
📦 addToStack 被调用:
  - word对象: [对象]
  - original: [单词]
  - meaning: [中文]
  - giveUp: [true/false]
  - 当前堆叠数: [数量]
📚 准备添加到错词本: [单词]
✅ 已添加到错词本
📦 准备添加到堆叠数组...
✅ 已添加到堆叠数组
✅ 添加完成，堆叠区信息:
  - 单词: [单词]
  - 位置: row:[行], col:[列]
  - 堆叠总数: [数量]
  - 堆叠列表: [单词列表]
✅ 验证成功：单词已在堆叠数组中
```

如果验证失败，会显示：
```
❌ 验证失败：单词未在堆叠数组中！
```

### 3. `drawStackedWords()` - 渲染堆叠区

每100帧随机输出一次（约1%概率）：
```
🎨 渲染堆叠区:
  - 堆叠总数: [数量]
  - 堆叠单词列表: [单词列表]
```

如果发现无效单词：
```
❌ 堆叠区发现空对象，索引: [索引]
或
❌ 堆叠区单词缺少original属性，索引: [索引], 完整对象: [JSON]
```

## 如何使用调试日志

### 1. 打开开发者工具

- **Chrome/Edge**: 按 `F12` 或 `Ctrl+Shift+I`
- **Firefox**: 按 `F12` 或 `Ctrl+Shift+I`

### 2. 切换到Console标签

在Console中可以看到所有调试信息。

### 3. 复现问题

1. 开始游戏
2. 让一个单词失败（不输入任何字母，让它下降到堆叠区）
3. 观察Console中的日志输出

### 4. 检查关键信息

需要特别关注的日志点：

#### A. 失败判定是否触发？
查找 `💥 单词失败判定触发` 日志。
- 如果没有这条日志，说明失败判定条件没有触发
- 检查单词的Y坐标和堆叠区顶部Y坐标

#### B. addToStack是否被调用？
查找 `📦 addToStack 被调用` 日志。
- 如果没有这条日志，说明addToStack方法没有被调用
- 检查updateFallingWords中的代码流程

#### C. 单词对象是否完整？
查看单词对象的详细信息：
```javascript
word对象: {
  original: "tree",      // 必须存在
  meaning: "树",         // 必须存在
  phonetic: "/triː/",
  missing: [1, 3],
  display: "t_e_",
  missingLetters: "re",
  // ... 其他属性
}
```

如果 `original` 或 `meaning` 缺失，会输出错误：
```
❌ 单词对象缺少original属性，完整对象: [JSON]
```

#### D. 堆叠数组是否包含单词？
查找 `✅ 验证成功：单词已在堆叠数组中` 或 `❌ 验证失败`。
- 如果显示失败，说明push操作没有生效
- 这可能是JavaScript引擎的问题或数组被意外修改

#### E. 渲染是否正常？
查找 `🎨 渲染堆叠区` 日志（较少输出）。
- 检查堆叠总数是否正确
- 检查单词列表是否包含失败的单词

## 可能的问题原因

### 1. 单词对象属性缺失

**症状**: 
- 有 `📦 addToStack 被调用` 日志
- 但是有 `❌ 单词对象缺少original属性` 错误

**原因**: 
- 词汇管理器返回的单词对象不完整
- 或者在传递过程中属性丢失

**解决方法**:
- 检查 `VocabularyManagerV2.getRandomWordFromAll()` 方法
- 检查 `releaseWord()` 中的展开运算符是否正确复制属性

### 2. 堆叠数组被意外清空

**症状**: 
- 有 `✅ 已添加到堆叠数组` 日志
- 但是渲染时堆叠区为空或缺少单词

**原因**: 
- `levelUp()` 方法清空了堆叠区（升级时）
- `resetGame()` 方法清空了堆叠区（重置时）
- 其他地方意外修改了 `stackedWords` 数组

**解决方法**:
- 检查是否在单词失败时意外触发了升级
- 检查是否有其他地方清空了数组

### 3. 渲染跳过了某些单词

**症状**: 
- `stackedWords` 数组包含单词
- 但是Canvas上没有显示

**原因**: 
- `drawStackedWords()` 中的验证逻辑跳过了某些单词
- 单词对象缺少 `original` 属性

**解决方法**:
- 检查是否有 `❌ 堆叠区单词缺少original属性` 错误
- 确保所有单词对象都有完整的属性

### 4. 失败判定条件错误

**症状**: 
- 单词下降到底部但没有触发失败判定
- 没有 `💥 单词失败判定触发` 日志

**原因**: 
- `getStackTopY()` 计算错误
- 失败判定条件 `word.y + word.height >= stackTopY` 不正确

**解决方法**:
- 检查堆叠区顶部Y坐标计算
- 检查单词的Y坐标和高度

## 预期的正常流程

当单词失败时，应该看到以下完整的日志序列：

```
💥 单词失败判定触发:
  单词: tree
  单词底部Y: 480
  堆叠区顶部Y: 450
  堆叠区当前单词数: 3
✅ 已从下降列表移除
✅ 已标记为失败（giveUp=false）
➡️ 准备调用 addToStack...
📦 addToStack 被调用:
  word对象: [Object object]
  original: tree
  meaning: 树
  giveUp: false
  当前堆叠数: 3
📚 准备添加到错词本: tree
✅ 已添加到错词本
📦 准备添加到堆叠数组...
✅ 已添加到堆叠数组
✅ 添加完成，堆叠区信息:
  单词: tree
  位置: row:0, col:3
  堆叠总数: 4
  堆叠列表: green, see, sleep, tree
✅ 验证成功：单词已在堆叠数组中
✅ addToStack 调用完成
📊 失败统计已更新，总失败数: 4
```

如果看到这个完整的序列，说明逻辑是正确的。如果中间某一步缺失或出错，就能定位问题所在。

## 下一步

1. **运行游戏并复现问题**
2. **查看Console日志**
3. **找到日志中的错误或异常**
4. **根据上面的"可能的问题原因"定位问题**
5. **提供日志截图或文本**，以便进一步分析

## 补充说明

这些调试日志会在生产环境中产生较多输出。在问题解决后，可以考虑：

1. 移除或注释掉部分日志
2. 使用条件编译或开发/生产模式切换
3. 保留关键的错误日志，移除详细的流程日志
