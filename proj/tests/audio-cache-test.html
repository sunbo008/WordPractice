<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘ç¼“å­˜ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #007bff;
            margin-top: 0;
        }
        
        .test-area {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
        
        .success {
            background: #d4edda;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        
        .warning {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }
        
        .error {
            background: #f8d7da;
            padding: 15px;
            border-left: 4px solid #dc3545;
            margin: 10px 0;
        }
        
        #console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        #console .log-info { color: #4fc3f7; }
        #console .log-success { color: #81c784; }
        #console .log-warning { color: #ffb74d; }
        #console .log-error { color: #e57373; }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .stats-table th {
            background: #007bff;
            color: white;
        }
        
        .stats-table tr:hover {
            background: #f5f5f5;
        }
        
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ğŸµ éŸ³é¢‘ç¼“å­˜ç³»ç»Ÿæµ‹è¯•é¡µé¢</h1>
    
    <div class="section">
        <h2>ğŸ“‹ ç³»ç»Ÿä¿¡æ¯</h2>
        <div id="systemInfo">
            <p>æ£€æµ‹ä¸­...</p>
        </div>
    </div>
    
    <div class="section">
        <h2>ğŸ¤ TTS æœåŠ¡æµ‹è¯•</h2>
        <div class="test-area">
            <input type="text" id="wordInput" placeholder="è¾“å…¥å•è¯ï¼ˆå¦‚ helloï¼‰" value="hello">
            <button onclick="testSpeak()">æ’­æ”¾å•è¯</button>
            <button onclick="testSpeakMultiple()">æ’­æ”¾å¤šä¸ªå•è¯</button>
            <button onclick="stopSpeaking()">åœæ­¢æ’­æ”¾</button>
        </div>
        <div class="info">
            ğŸ’¡ é¦–æ¬¡æ’­æ”¾ä¼šä¸‹è½½éŸ³é¢‘å¹¶ç¼“å­˜ï¼Œç¬¬äºŒæ¬¡æ’­æ”¾ä¼šç›´æ¥ä½¿ç”¨ç¼“å­˜
        </div>
    </div>
    
    <div class="section">
        <h2>ğŸ’¾ ç¼“å­˜ç®¡ç†</h2>
        <div class="test-area">
            <button onclick="showCacheStats()">æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡</button>
            <button onclick="clearCache()">æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</button>
            <button onclick="downloadLocalAudios()">æ‰¹é‡ä¸‹è½½éŸ³é¢‘ï¼ˆæœ¬åœ°å¼€å‘ï¼‰</button>
        </div>
        <div id="cacheStats"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ§ª æµ‹è¯•åœºæ™¯</h2>
        <div class="test-area">
            <button onclick="testLocalFile()">æµ‹è¯•æœ¬åœ°æ–‡ä»¶ä¼˜å…ˆçº§</button>
            <button onclick="testIndexedDB()">æµ‹è¯• IndexedDB ç¼“å­˜</button>
            <button onclick="testOnlineDownload()">æµ‹è¯•åœ¨çº¿ä¸‹è½½</button>
            <button onclick="testCacheReuse()">æµ‹è¯•ç¼“å­˜å¤ç”¨</button>
        </div>
    </div>
    
    <div class="section">
        <h2>ğŸ“Š æ§åˆ¶å°æ—¥å¿—</h2>
        <div class="test-area">
            <button onclick="clearConsole()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="copyConsole()">å¤åˆ¶æ—¥å¿—</button>
        </div>
        <div id="console"></div>
    </div>
    
    <!-- å¼•å…¥éŸ³é¢‘ç¼“å­˜ç®¡ç†å™¨ -->
    <script src="../src/utils/AudioCacheManager.js"></script>
    
    <!-- å¼•å…¥ TTS æœåŠ¡ -->
    <script src="../src/utils/TTSService.js"></script>
    
    <script>
        let ttsService;
        let cacheManager;
        const consoleDiv = document.getElementById('console');
        
        // é‡å†™ console æ–¹æ³•ï¼Œæ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                hour12: false, 
                fractionalSecondDigits: 3 
            });
            const line = document.createElement('div');
            line.className = `log-${type}`;
            line.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'info');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warning');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–...');
            
            // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
            const systemInfoDiv = document.getElementById('systemInfo');
            const isLocal = location.hostname === 'localhost' || 
                           location.hostname === '127.0.0.1' || 
                           location.hostname === '';
            const hasIndexedDB = 'indexedDB' in window;
            
            systemInfoDiv.innerHTML = `
                <p><strong>ç¯å¢ƒï¼š</strong>${isLocal ? 'æœ¬åœ°å¼€å‘' : 'Vercel éƒ¨ç½²'}</p>
                <p><strong>æµè§ˆå™¨ï¼š</strong>${navigator.userAgent}</p>
                <p><strong>IndexedDB æ”¯æŒï¼š</strong>${hasIndexedDB ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
            `;
            
            // åˆå§‹åŒ– TTS æœåŠ¡
            ttsService = TTSService.getInstance();
            await ttsService.initialize();
            
            // è·å–ç¼“å­˜ç®¡ç†å™¨
            cacheManager = AudioCacheManager.getInstance();
            
            console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            
            // æ˜¾ç¤ºåˆå§‹ç¼“å­˜ç»Ÿè®¡
            await showCacheStats();
        }
        
        // æ’­æ”¾å•è¯
        async function testSpeak() {
            const word = document.getElementById('wordInput').value.trim();
            if (!word) {
                alert('è¯·è¾“å…¥å•è¯');
                return;
            }
            
            console.log(`ğŸ¤ æ’­æ”¾å•è¯: ${word}`);
            
            try {
                await ttsService.speak(word, {
                    showError: false,
                    onSuccess: (provider, duration) => {
                        console.log(`âœ… æ’­æ”¾æˆåŠŸ: ${word} (${provider}, ${duration}ms)`);
                    },
                    onError: (error) => {
                        console.error(`âŒ æ’­æ”¾å¤±è´¥: ${error.message || error}`);
                    }
                });
            } catch (error) {
                console.error(`âŒ æ’­æ”¾å¼‚å¸¸: ${error.message || error}`);
            }
        }
        
        // æ’­æ”¾å¤šä¸ªå•è¯
        async function testSpeakMultiple() {
            const words = ['hello', 'world', 'good', 'morning', 'see'];
            console.log(`ğŸ¤ æ’­æ”¾ ${words.length} ä¸ªå•è¯...`);
            
            for (const word of words) {
                console.log(`   æ’­æ”¾: ${word}`);
                await ttsService.speak(word, { showError: false });
                await new Promise(resolve => setTimeout(resolve, 500)); // é—´éš”500ms
            }
            
            console.log('âœ… å…¨éƒ¨æ’­æ”¾å®Œæˆ');
            await showCacheStats();
        }
        
        // åœæ­¢æ’­æ”¾
        function stopSpeaking() {
            console.log('â¹ï¸ åœæ­¢æ’­æ”¾');
            ttsService.stop();
        }
        
        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
        async function showCacheStats() {
            console.log('ğŸ“Š æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡...');
            
            try {
                const stats = await cacheManager.getStats();
                const statsDiv = document.getElementById('cacheStats');
                
                if (stats.total === 0) {
                    statsDiv.innerHTML = '<div class="info">æš‚æ— ç¼“å­˜</div>';
                } else {
                    let html = `
                        <div class="success">
                            <strong>ç¼“å­˜ç»Ÿè®¡ï¼š</strong>å…± ${stats.total} ä¸ªéŸ³é¢‘ï¼Œæ€»å¤§å° ${stats.totalSizeMB} MB
                        </div>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>å•è¯</th>
                                    <th>æä¾›å•†</th>
                                    <th>å¤§å°</th>
                                    <th>ç¼“å­˜æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    stats.items.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.word}</td>
                                <td>${item.provider}</td>
                                <td>${item.sizeKB} KB</td>
                                <td>${item.date}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    statsDiv.innerHTML = html;
                }
                
                console.log(`âœ… ç¼“å­˜ç»Ÿè®¡: ${stats.total} ä¸ªéŸ³é¢‘, ${stats.totalSizeMB} MB`);
                
            } catch (error) {
                console.error(`âŒ æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡å¤±è´¥: ${error.message || error}`);
                document.getElementById('cacheStats').innerHTML = 
                    `<div class="error">æŸ¥è¯¢å¤±è´¥: ${error.message || error}</div>`;
            }
        }
        
        // æ¸…ç©ºç¼“å­˜
        async function clearCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) {
                return;
            }
            
            console.log('ğŸ—‘ï¸ æ¸…ç©ºç¼“å­˜...');
            
            try {
                await cacheManager.clearAllCache();
                console.log('âœ… ç¼“å­˜å·²æ¸…ç©º');
                await showCacheStats();
            } catch (error) {
                console.error(`âŒ æ¸…ç©ºç¼“å­˜å¤±è´¥: ${error.message || error}`);
            }
        }
        
        // æ‰¹é‡ä¸‹è½½éŸ³é¢‘
        function downloadLocalAudios() {
            console.log('ğŸ“¥ æ‰¹é‡ä¸‹è½½éŸ³é¢‘...');
            
            if (typeof downloadLocalAudio === 'function') {
                downloadLocalAudio();
            } else {
                console.warn('âš ï¸ downloadLocalAudio() å‡½æ•°æœªå®šä¹‰ï¼Œè¯·å…ˆæ’­æ”¾ä¸€äº›å•è¯');
            }
        }
        
        // æµ‹è¯•æœ¬åœ°æ–‡ä»¶ä¼˜å…ˆçº§
        async function testLocalFile() {
            console.log('ğŸ§ª æµ‹è¯•æœ¬åœ°æ–‡ä»¶ä¼˜å…ˆçº§...');
            console.log('ğŸ’¡ è¯·åœ¨ proj/audio/ ç›®å½•æ”¾ç½® test_baidu.mp3 æ–‡ä»¶');
            
            await ttsService.speak('test', { showError: false });
        }
        
        // æµ‹è¯• IndexedDB ç¼“å­˜
        async function testIndexedDB() {
            console.log('ğŸ§ª æµ‹è¯• IndexedDB ç¼“å­˜...');
            
            const testWord = 'cache';
            
            // ç¬¬ä¸€æ¬¡æ’­æ”¾ï¼ˆä¸‹è½½å¹¶ç¼“å­˜ï¼‰
            console.log('   ç¬¬ä¸€æ¬¡æ’­æ”¾ï¼ˆåº”è¯¥ä¸‹è½½ï¼‰...');
            await ttsService.speak(testWord, { showError: false });
            
            // ç­‰å¾…ç¼“å­˜ä¿å­˜
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // ç¬¬äºŒæ¬¡æ’­æ”¾ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
            console.log('   ç¬¬äºŒæ¬¡æ’­æ”¾ï¼ˆåº”è¯¥ä½¿ç”¨ç¼“å­˜ï¼‰...');
            await ttsService.speak(testWord, { showError: false });
            
            console.log('âœ… æµ‹è¯•å®Œæˆ');
        }
        
        // æµ‹è¯•åœ¨çº¿ä¸‹è½½
        async function testOnlineDownload() {
            console.log('ğŸ§ª æµ‹è¯•åœ¨çº¿ä¸‹è½½...');
            
            const randomWord = 'test' + Math.random().toString(36).substring(7);
            console.log(`   éšæœºå•è¯: ${randomWord}`);
            
            await ttsService.speak(randomWord, { showError: false });
            
            console.log('âœ… æµ‹è¯•å®Œæˆ');
        }
        
        // æµ‹è¯•ç¼“å­˜å¤ç”¨
        async function testCacheReuse() {
            console.log('ğŸ§ª æµ‹è¯•ç¼“å­˜å¤ç”¨...');
            
            const word = 'reuse';
            
            // æ’­æ”¾3æ¬¡
            for (let i = 1; i <= 3; i++) {
                console.log(`   ç¬¬ ${i} æ¬¡æ’­æ”¾...`);
                await ttsService.speak(word, { showError: false });
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            console.log('âœ… æµ‹è¯•å®Œæˆï¼ˆåº”è¯¥åªæœ‰ç¬¬1æ¬¡ä¸‹è½½ï¼Œå2æ¬¡ä½¿ç”¨ç¼“å­˜ï¼‰');
        }
        
        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            consoleDiv.innerHTML = '';
            console.log('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // å¤åˆ¶æ§åˆ¶å°
        function copyConsole() {
            const text = consoleDiv.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>



