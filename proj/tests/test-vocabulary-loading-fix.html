<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯åº“åŠ è½½ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h2 {
            color: #3498db;
            margin-bottom: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d5f4e6; color: #27ae60; }
        .status.error { background: #f8d7da; color: #e74c3c; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .result-box {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-top: 10px;
            font-family: monospace;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª è¯åº“åŠ è½½ä¿®å¤æµ‹è¯•</h1>
        
        <!-- æµ‹è¯•1: LocalStorageæ£€æŸ?-->
        <div class="test-section">
            <h2>1ï¸âƒ£ LocalStorage ç”¨æˆ·é€‰æ‹©æ£€æŸ?/h2>
            <div id="storage-status" class="status info">å‡†å¤‡æ£€æŸ?..</div>
            <button class="btn" onclick="checkLocalStorage()">æ£€æŸ¥å­˜å‚?/button>
            <button class="btn" onclick="clearLocalStorage()">æ¸…ç©ºå­˜å‚¨</button>
            <button class="btn" onclick="setTestSelection()">è®¾ç½®æµ‹è¯•é€‰æ‹©ï¼ˆåªé€‰Day1ï¼?/button>
            <div id="storage-result"></div>
        </div>
        
        <!-- æµ‹è¯•2: VocabularyManageråŠ è½½ -->
        <div class="test-section">
            <h2>2ï¸âƒ£ VocabularyManagerV2 åŠ è½½æµ‹è¯•</h2>
            <div id="vocab-status" class="status info">å‡†å¤‡åŠ è½½...</div>
            <button class="btn" onclick="testVocabularyManager()">æµ‹è¯•åŠ è½½</button>
            <div id="vocab-result"></div>
        </div>
        
        <!-- æµ‹è¯•3: å•è¯æ•°ç»Ÿè®?-->
        <div class="test-section">
            <h2>3ï¸âƒ£ å•è¯æ•°ç»Ÿè®¡éªŒè¯?/h2>
            <div id="count-status" class="status info">å‡†å¤‡ç»Ÿè®¡...</div>
            <button class="btn" onclick="testWordCount()">éªŒè¯å•è¯æ•?/button>
            <div id="count-result"></div>
        </div>
    </div>

    <script src="../src/core/vocabulary-manager-v2.js"></script>
    <script>
        let vocabularyManager = null;
        
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        function checkLocalStorage() {
            const savedLibraries = localStorage.getItem('wordTetris_selectedLibraries');
            const resultDiv = document.getElementById('storage-result');
            
            if (savedLibraries) {
                try {
                    const libraries = JSON.parse(savedLibraries);
                    updateStatus('storage-status', `âœ?æ‰¾åˆ°ç”¨æˆ·é€‰æ‹©: ${libraries.length}ä¸ªè¯åº“`, 'success');
                    
                    resultDiv.innerHTML = `
                        <div class="result-box">
                            <strong>å·²é€‰æ‹©çš„è¯åº“ID:</strong><br>
                            ${libraries.map(id => `<span class="highlight">${id}</span>`).join(', ')}
                        </div>
                    `;
                } catch (error) {
                    updateStatus('storage-status', 'â?æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                    resultDiv.innerHTML = `<div class="result-box">é”™è¯¯: ${error.message}</div>`;
                }
            } else {
                updateStatus('storage-status', 'âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·é€‰æ‹©ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®', 'info');
                resultDiv.innerHTML = `<div class="result-box">LocalStorageä¸­æ²¡æœ‰ä¿å­˜çš„é€‰æ‹©</div>`;
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('wordTetris_selectedLibraries');
            updateStatus('storage-status', 'ğŸ—‘ï¸?å·²æ¸…ç©ºå­˜å‚?, 'info');
            document.getElementById('storage-result').innerHTML = '';
        }
        
        function setTestSelection() {
            // åªé€‰æ‹©Day 1
            const testSelection = ['day01'];
            localStorage.setItem('wordTetris_selectedLibraries', JSON.stringify(testSelection));
            updateStatus('storage-status', 'âœ?å·²è®¾ç½®æµ‹è¯•é€‰æ‹©ï¼ˆåªé€‰Day1 - 10ä¸ªå•è¯ï¼‰', 'success');
            checkLocalStorage();
        }
        
        async function testVocabularyManager() {
            try {
                updateStatus('vocab-status', 'æ­£åœ¨åˆå§‹åŒ–VocabularyManagerV2...', 'info');
                
                vocabularyManager = new VocabularyManagerV2();
                
                // ç­‰å¾…åŠ è½½å®Œæˆ
                let attempts = 0;
                while (!vocabularyManager.isLoaded && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!vocabularyManager.isLoaded) {
                    throw new Error('åŠ è½½è¶…æ—¶');
                }
                
                updateStatus('vocab-status', 'âœ?VocabularyManagerV2åŠ è½½æˆåŠŸï¼?, 'success');
                
                // æ˜¾ç¤ºåŠ è½½çš„è¯åº“ä¿¡æ?
                const stats = vocabularyManager.getLibraryStats();
                const config = vocabularyManager.getCurrentConfig();
                
                const resultDiv = document.getElementById('vocab-result');
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <strong>åŠ è½½ç»Ÿè®¡:</strong><br>
                        å·²åŠ è½½è¯åº“æ•°: <span class="highlight">${stats.totalLibraries}</span><br>
                        æ€»å•è¯æ•°: <span class="highlight">${stats.totalWords}</span><br>
                        <br>
                        <strong>å½“å‰é…ç½®:</strong><br>
                        å¯ç”¨çš„è¯åº? ${config.enabledLibraries.map(id => `<span class="highlight">${id}</span>`).join(', ')}<br>
                        <br>
                        <strong>å„è¯åº“è¯¦æƒ?</strong><br>
                        ${stats.libraries.map(lib => 
                            `- ${lib.name}: ${lib.wordCount}ä¸ªå•è¯?(éš¾åº¦: ${lib.difficulty})`
                        ).join('<br>')}
                    </div>
                `;
                
            } catch (error) {
                updateStatus('vocab-status', `â?åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }
        
        async function testWordCount() {
            if (!vocabularyManager) {
                updateStatus('count-status', 'â?è¯·å…ˆåŠ è½½VocabularyManager', 'error');
                return;
            }
            
            try {
                updateStatus('count-status', 'æ­£åœ¨ç»Ÿè®¡å•è¯æ•?..', 'info');
                
                const stats = vocabularyManager.getVocabularyStats();
                const config = vocabularyManager.getCurrentConfig();
                
                // æ‰‹åŠ¨è®¡ç®—æœŸæœ›çš„å•è¯æ•°
                let expectedWords = 0;
                const savedLibraries = localStorage.getItem('wordTetris_selectedLibraries');
                let selectedIds = config.enabledLibraries;
                
                if (savedLibraries) {
                    selectedIds = JSON.parse(savedLibraries);
                }
                
                // ä»config-v2.jsonè¯»å–æœŸæœ›å€?
                const configResponse = await fetch('../words/config-v2.json');
                const configData = await configResponse.json();
                
                for (const categoryData of configData.categories) {
                    if (categoryData.subcategories) {
                        for (const sub of categoryData.subcategories) {
                            if (sub.items) {
                                for (const item of sub.items) {
                                    if (selectedIds.includes(item.id)) {
                                        expectedWords += item.wordCount || 0;
                                    }
                                }
                            } else {
                                if (selectedIds.includes(sub.id)) {
                                    expectedWords += sub.wordCount || 0;
                                }
                            }
                        }
                    }
                }
                
                const isCorrect = stats.totalWords === expectedWords;
                
                updateStatus('count-status', 
                    isCorrect ? 'âœ?å•è¯æ•°ç»Ÿè®¡æ­£ç¡®ï¼' : 'â?å•è¯æ•°ç»Ÿè®¡ä¸åŒ¹é…ï¼?, 
                    isCorrect ? 'success' : 'error'
                );
                
                const resultDiv = document.getElementById('count-result');
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <strong>ç»Ÿè®¡ç»“æœ:</strong><br>
                        å®é™…åŠ è½½å•è¯æ•? <span class="highlight">${stats.totalWords}</span><br>
                        æœŸæœ›å•è¯æ•? <span class="highlight">${expectedWords}</span><br>
                        åŒ¹é…çŠ¶æ€? <span class="highlight ${isCorrect ? 'success' : 'error'}">${isCorrect ? 'âœ?æ­£ç¡®' : 'âœ?ä¸åŒ¹é…?}</span><br>
                        <br>
                        <strong>å·²é€‰è¯åº?</strong><br>
                        ${selectedIds.map(id => `<span class="highlight">${id}</span>`).join(', ')}
                    </div>
                `;
                
            } catch (error) {
                updateStatus('count-status', `â?ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
                console.error('ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥LocalStorage
        document.addEventListener('DOMContentLoaded', () => {
            checkLocalStorage();
        });
    </script>
</body>
</html>

