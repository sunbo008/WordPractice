/**
 * åŠ¨æ€è¯åº“é…ç½®åŠ è½½å™¨
 * è¿è¡Œæ—¶è‡ªåŠ¨æ‰«æ words ç›®å½•ï¼Œç”Ÿæˆé…ç½®
 */
class VocabularyConfigLoader {
    constructor() {
        this.config = null;
        this.loadError = null;
    }
    
    /**
     * åŠ è½½é…ç½®ï¼ˆè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆï¼‰
     */
    async loadConfig() {
        try {
            console.log('ğŸ”„ å¼€å§‹åŠ¨æ€åŠ è½½è¯åº“é…ç½®...');
            
            // å¹¶è¡Œæ‰«ææ‰€æœ‰ç›®å½•
            const [dailyPhonics, specialPractice, gradeBased] = await Promise.all([
                this.scanDailyPhonics(),
                this.scanSpecialPractice(),
                this.scanGradeBased()
            ]);
            
            // æ„å»ºé…ç½®å¯¹è±¡
            this.config = {
                metadata: {
                    version: "2.0",
                    description: "Word Tetris åˆ†å¸ƒå¼è¯åº“é…ç½® - è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ",
                    lastUpdated: new Date().toISOString().split('T')[0],
                    autoGenerated: true,
                    generatedBy: "JavaScript Runtime"
                },
                categories: [
                    {
                        id: "daily-phonics",
                        name: "æŒ‰å¤©å­¦ä¹ éŸ³æ ‡",
                        description: "15å¤©éŸ³æ ‡å­¦ä¹ è®¡åˆ’ï¼Œç³»ç»ŸæŒæ¡åŸºç¡€éŸ³æ ‡",
                        icon: "ğŸ“…",
                        subcategories: dailyPhonics
                    },
                    {
                        id: "special-practice",
                        name: "ä¸“é¡¹å¼ºåŒ–ç»ƒä¹ ",
                        description: "é’ˆå¯¹é‡ç‚¹éŸ³æ ‡è¿›è¡Œå¼ºåŒ–è®­ç»ƒ",
                        icon: "ğŸ¯",
                        subcategories: specialPractice
                    },
                    {
                        id: "grade-based",
                        name: "æŒ‰å¹´çº§åˆ†ç±»",
                        description: "å°å­¦ã€åˆä¸­ã€é«˜ä¸­å„å¹´çº§å­¦æœŸè¯æ±‡",
                        icon: "ğŸ“",
                        subcategories: gradeBased
                    }
                ],
                defaultConfig: {
                    enabledLibraries: dailyPhonics.slice(0, 4).map(item => item.id),
                    maxWords: 200,
                    difficultyRange: [1, 3],
                    categories: ["daily-phonics"]
                }
            };
            
            console.log('âœ… é…ç½®åŠ è½½å®Œæˆ:', {
                dailyPhonics: dailyPhonics.length,
                specialPractice: specialPractice.length,
                gradeBased: this.countGradeItems(gradeBased)
            });
            
            return this.config;
            
        } catch (error) {
            console.error('âŒ é…ç½®åŠ è½½å¤±è´¥:', error);
            this.loadError = error;
            throw error;
        }
    }
    
    /**
     * æ‰«æ daily-phonics ç›®å½•
     */
    async scanDailyPhonics() {
        const directory = './words/daily-phonics';
        const filePattern = /^day\d+\.json$/;
        
        // å°è¯•åŠ è½½å·²çŸ¥çš„æ–‡ä»¶å
        const knownFiles = [
            'day01', 'day02', 'day03', 'day04', 'day05',
            'day06', 'day07', 'day08', 'day09', 'day10',
            'day11', 'day12', 'day13', 'day14', 'day15'
        ];
        
        const results = [];
        
        for (const filename of knownFiles) {
            const filepath = `${directory}/${filename}.json`;
            
            try {
                const response = await fetch(filepath);
                if (!response.ok) continue; // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡
                
                const data = await response.json();
                const metadata = data.metadata || {};
                
                results.push({
                    id: metadata.id || filename,
                    name: metadata.name || filename,
                    filename: `daily-phonics/${filename}.json`,
                    phoneme: metadata.phoneme || '',
                    description: metadata.description || '',
                    wordCount: metadata.wordCount || data.words?.length || 0,
                    difficulty: metadata.difficulty || 'beginner',
                    recommended: true
                });
                
                console.log(`  âœ“ ${filename}.json`);
            } catch (error) {
                // æ–‡ä»¶ä¸å­˜åœ¨æˆ–è§£æå¤±è´¥ï¼Œé™é»˜è·³è¿‡
                console.log(`  âŠ˜ ${filename}.json (not found)`);
            }
        }
        
        return results.sort((a, b) => a.id.localeCompare(b.id));
    }
    
    /**
     * æ‰«æ special-practice ç›®å½•
     */
    async scanSpecialPractice() {
        const directory = './words/special-practice';
        
        // å·²çŸ¥çš„ä¸“é¡¹ç»ƒä¹ æ–‡ä»¶
        const knownFiles = [
            'ae-practice',
            'e-practice',
            'or-practice',
            'o-practice'
        ];
        
        const results = [];
        
        for (const filename of knownFiles) {
            const filepath = `${directory}/${filename}.json`;
            
            try {
                const response = await fetch(filepath);
                if (!response.ok) continue;
                
                const data = await response.json();
                const metadata = data.metadata || {};
                
                results.push({
                    id: metadata.id || filename,
                    name: metadata.name || filename,
                    filename: `special-practice/${filename}.json`,
                    phoneme: metadata.phoneme || '',
                    description: metadata.description || '',
                    wordCount: metadata.wordCount || data.words?.length || 0,
                    difficulty: metadata.difficulty || 'intermediate',
                    recommended: false
                });
                
                console.log(`  âœ“ ${filename}.json`);
            } catch (error) {
                console.log(`  âŠ˜ ${filename}.json (not found)`);
            }
        }
        
        return results;
    }
    
    /**
     * æ‰«æ grade-based ç›®å½•
     */
    async scanGradeBased() {
        const gradeStructure = {
            primary: {
                id: "primary-school",
                name: "å°å­¦è¯æ±‡",
                description: "å°å­¦ä¸‰è‡³å…­å¹´çº§è¯æ±‡",
                grades: [
                    {id: "grade3-term1", name: "ä¸‰å¹´çº§ä¸Šå­¦æœŸ", words: 50},
                    {id: "grade3-term2", name: "ä¸‰å¹´çº§ä¸‹å­¦æœŸ", words: 50},
                    {id: "grade4-term1", name: "å››å¹´çº§ä¸Šå­¦æœŸ", words: 60},
                    {id: "grade4-term2", name: "å››å¹´çº§ä¸‹å­¦æœŸ", words: 60},
                    {id: "grade5-term1", name: "äº”å¹´çº§ä¸Šå­¦æœŸ", words: 70},
                    {id: "grade5-term2", name: "äº”å¹´çº§ä¸‹å­¦æœŸ", words: 70},
                    {id: "grade6-term1", name: "å…­å¹´çº§ä¸Šå­¦æœŸ", words: 80},
                    {id: "grade6-term2", name: "å…­å¹´çº§ä¸‹å­¦æœŸ", words: 80}
                ]
            },
            middle: {
                id: "middle-school",
                name: "åˆä¸­è¯æ±‡",
                description: "åˆä¸­ä¸ƒè‡³ä¹å¹´çº§è¯æ±‡",
                grades: [
                    {id: "grade7-term1", name: "ä¸ƒå¹´çº§ä¸Šå­¦æœŸ", words: 100},
                    {id: "grade7-term2", name: "ä¸ƒå¹´çº§ä¸‹å­¦æœŸ", words: 100},
                    {id: "grade8-term1", name: "å…«å¹´çº§ä¸Šå­¦æœŸ", words: 120},
                    {id: "grade8-term2", name: "å…«å¹´çº§ä¸‹å­¦æœŸ", words: 120},
                    {id: "grade9-term1", name: "ä¹å¹´çº§ä¸Šå­¦æœŸ", words: 150},
                    {id: "grade9-term2", name: "ä¹å¹´çº§ä¸‹å­¦æœŸ", words: 150}
                ]
            },
            high: {
                id: "high-school",
                name: "é«˜ä¸­è¯æ±‡",
                description: "é«˜ä¸­åè‡³åäºŒå¹´çº§è¯æ±‡",
                grades: [
                    {id: "grade10-term1", name: "é«˜ä¸€ä¸Šå­¦æœŸ", words: 200},
                    {id: "grade10-term2", name: "é«˜ä¸€ä¸‹å­¦æœŸ", words: 200},
                    {id: "grade11-term1", name: "é«˜äºŒä¸Šå­¦æœŸ", words: 200},
                    {id: "grade11-term2", name: "é«˜äºŒä¸‹å­¦æœŸ", words: 200},
                    {id: "grade12-term1", name: "é«˜ä¸‰ä¸Šå­¦æœŸ", words: 200},
                    {id: "grade12-term2", name: "é«˜ä¸‰ä¸‹å­¦æœŸ", words: 200}
                ]
            }
        };
        
        const subcategories = [];
        
        for (const [levelKey, levelInfo] of Object.entries(gradeStructure)) {
            const items = [];
            
            for (const grade of levelInfo.grades) {
                const filepath = `./words/grade-based/${levelKey}/${grade.id}.json`;
                
                try {
                    const response = await fetch(filepath);
                    if (response.ok) {
                        const data = await response.json();
                        const metadata = data.metadata || {};
                        
                        items.push({
                            id: metadata.id || grade.id,
                            name: metadata.name || grade.name,
                            filename: `grade-based/${levelKey}/${grade.id}.json`,
                            description: metadata.description || `${grade.name}å¿…å­¦è¯æ±‡`,
                            wordCount: metadata.wordCount || data.words?.length || grade.words,
                            difficulty: metadata.difficulty || 'beginner',
                            recommended: true
                        });
                        
                        console.log(`  âœ“ ${levelKey}/${grade.id}.json`);
                    } else {
                        // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨å ä½ç¬¦
                        items.push({
                            id: grade.id,
                            name: grade.name,
                            filename: `grade-based/${levelKey}/${grade.id}.json`,
                            description: `${grade.name}å¿…å­¦è¯æ±‡`,
                            wordCount: grade.words,
                            difficulty: 'beginner',
                            recommended: true
                        });
                    }
                } catch (error) {
                    // ä½¿ç”¨å ä½ç¬¦
                    items.push({
                        id: grade.id,
                        name: grade.name,
                        filename: `grade-based/${levelKey}/${grade.id}.json`,
                        description: `${grade.name}å¿…å­¦è¯æ±‡`,
                        wordCount: grade.words,
                        difficulty: 'beginner',
                        recommended: true
                    });
                }
            }
            
            subcategories.push({
                id: levelInfo.id,
                name: levelInfo.name,
                description: levelInfo.description,
                items: items
            });
        }
        
        return subcategories;
    }
    
    /**
     * ç»Ÿè®¡å¹´çº§åˆ†ç±»çš„é¡¹ç›®æ•°
     */
    countGradeItems(gradeBased) {
        return gradeBased.reduce((sum, category) => sum + category.items.length, 0);
    }
    
    /**
     * è·å–é…ç½®
     */
    getConfig() {
        return this.config;
    }
}

// å¯¼å‡ºå•ä¾‹
window.VocabularyConfigLoader = VocabularyConfigLoader;

